<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LuCash $ - Gesti√≥n de Remesas</title>
    <link rel="stylesheet" href="./style.css?v=8">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#10b981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="auth-hidden">
    <!-- LOGIN OVERLAY -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-card">
            <div class="auth-header">
                <img src="./icons/icon-192.png" alt="LuCash Logo" class="auth-logo">
                <h2>Bienvenido a LuCash $</h2>
                <p id="authSubtitle">Inicia sesi√≥n para gestionar tus remesas</p>
            </div>
            <form id="authForm" class="auth-form">
                <div class="input-group">
                    <label>Correo Electr√≥nico</label>
                    <input type="email" id="authEmail" placeholder="tu@email.com" required>
                </div>
                <div class="input-group">
                    <label style="display: flex; align-items: center; gap: 5px;">
                        Contrase√±a
                        <div class="info-icon" id="pwRequirements">
                            <i data-lucide="info" style="width:14px; height:14px;"></i>
                            <span class="tooltip">Min. 8 caracteres, May√∫scula, Min√∫scula, N√∫mero y S√≠mbolo</span>
                        </div>
                    </label>
                    <div class="password-wrapper">
                        <input type="password" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                        <button type="button" class="toggle-password"
                            onclick="togglePasswordVisibility('authPassword')">
                            <i data-lucide="eye" class="eye-icon"></i>
                        </button>
                    </div>
                </div>
                <div class="input-group" id="confirmPasswordGroup" style="display: none;">
                    <label>Confirmar Contrase√±a</label>
                    <div class="password-wrapper">
                        <input type="password" id="authConfirmPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        <button type="button" class="toggle-password"
                            onclick="togglePasswordVisibility('authConfirmPassword')">
                            <i data-lucide="eye" class="eye-icon"></i>
                        </button>
                    </div>
                </div>
                <button type="submit" id="authSubmitBtn" class="action-btn">Entrar</button>
            </form>
            <div class="auth-footer">
                <p id="toggleAuthText">¬øNo tienes cuenta? <a href="#" id="toggleAuthMode">Reg√≠strate gratis</a></p>
            </div>
        </div>
    </div>
    <div id="menuOverlay" class="menu-overlay" onclick="toggleMenu()"></div>
    <div id="sideMenu" class="side-menu">
        <div class="side-menu-header">
            <img src="./icons/icon-192.png" alt="Logo" style="width: 40px;">
            <h3>Menu</h3>
            <button class="close-menu" onclick="toggleMenu()">
                <i data-lucide="x"></i>
            </button>
        </div>
        <nav class="nav-menu-vertical" id="mainNav">
            <button class="menu-item active" onclick="handleNav('dashboard')">üè† Dashboard</button>
            <button class="menu-item" onclick="handleNav('transactions')">üíº Op. Binance</button>
            <button class="menu-item" onclick="handleNav('calculator')">üßÆ Calculadora</button>
            <button class="menu-item" onclick="handleNav('generator')">üì∑ Tasa del d√≠a</button>
            <button class="menu-item" onclick="handleNav('collaborators')">üë• Colaboradores</button>
        </nav>
        <div class="side-menu-footer">
            <button class="logout-btn" onclick="logout()">
                <i data-lucide="log-out" style="width:16px;"></i> Cerrar Sesi√≥n
            </button>
        </div>
    </div>

    <div class="container">
        <header class="main-header">
            <button class="menu-toggle" onclick="toggleMenu()">
                <i data-lucide="menu"></i>
            </button>
            <h1>LuCash $</h1>
            <div class="desktop-hidden" style="width: 40px;"></div>
        </header>

        <!-- DASHBOARD SECTION -->
        <section id="dashboardSection">
            <div class="filters-bar" style="margin-bottom: 2rem;">
                <div class="filter-group">
                    <label>Desde (Dashboard):</label>
                    <input type="date" id="dashDateFrom">
                </div>
                <div class="filter-group">
                    <label>Hasta (Dashboard):</label>
                    <input type="date" id="dashDateTo">
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="stat-card">
                    <span class="stat-label">Ganancia Periodo</span>
                    <span class="stat-value" id="statPeriodProfit">0.00 USDT</span>
                </div>
                <div class="stat-card highlight">
                    <span class="stat-label">Mi Ganancia Mes</span>
                    <span class="stat-value" id="statUserGainMonth">0.00 USDT</span>
                </div>
                <div class="stat-card urgent">
                    <span class="stat-label">Total por Liquidar</span>
                    <span class="stat-value" id="statTotalPending">0.00 USDT</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Volumen Total COP</span>
                    <span class="stat-value" id="statVolCop">$ 0</span>
                </div>
            </div>

            <div class="chart-container card">
                <h3>Ganancia por Per√≠odo</h3>
                <canvas id="profitChart"></canvas>
            </div>

            <div class="card">
                <h3>Resumen por Colaborador</h3>
                <div class="table-container">
                    <table id="colabSummaryTable">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Op.</th>
                                <th>Pte. Liquidar</th>
                                <th>Total Ganado</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- TRANSACTIONS SECTION -->
        <section id="transactionsSection" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h3>Registro de Operaciones</h3>
                    <button class="action-btn small" onclick="openTransactionModal()">+ Nueva</button>
                </div>

                <div class="filters-bar">
                    <div class="filter-group">
                        <label>Desde:</label>
                        <input type="date" id="filterDateFrom">
                    </div>
                    <div class="filter-group">
                        <label>Hasta:</label>
                        <input type="date" id="filterDateTo">
                    </div>
                    <div class="filter-group">
                        <label>Colaborador:</label>
                        <select id="filterColab">
                            <option value="">Todo</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Tipo:</label>
                        <select id="filterType">
                            <option value="">Todo</option>
                            <option value="COP_VES">COP ‚Üí VES</option>
                            <option value="VES_COP">VES ‚Üí COP</option>
                        </select>
                    </div>
                </div>

                <div class="bulk-actions" style="margin-bottom: 1rem; display: flex; gap: 10px;">
                    <button class="secondary-btn small" onclick="toggleSelectAll()">Seleccionar Todo</button>
                    <button class="action-btn small" onclick="liquidateSelected()"
                        style="background: var(--success); width: auto;">‚úÖ Liquidar Seleccionados</button>
                </div>

                <div class="table-container">
                    <table id="transactionsTable">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll()"></th>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Colab.</th>
                                <th>Tipo</th>
                                <th>Tasa</th>
                                <th>Recibido</th>
                                <th>Entregar</th>
                                <th>USDT Comp.</th>
                                <th>USDT Vend.</th>
                                <th>P. Compra USDT</th>
                                <th>C. Bin Buy</th>
                                <th>C. Bin Sell</th>
                                <th>Com. Banco</th>
                                <th>G. Bruta</th>
                                <th>Mi Ganancia</th>
                                <th>G. Colab</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <button class="secondary-btn" onclick="exportToExcel()">üìä Exportar Excel</button>
            </div>
        </section>

        <!-- CALCULATOR SECTION -->
        <section id="calculatorSection" style="display: none;">
            <div class="toggle-container" id="directionToggle">
                <button class="toggle-btn active" data-direction="COP_VES">COP ‚Üí VES</button>
                <button class="toggle-btn" data-direction="VES_COP">VES ‚Üí COP</button>
            </div>

            <div class="calculator-form card">
                <div class="input-group">
                    <label id="buyLabel">Precio Compra (COP)</label>
                    <input type="number" id="inputBuy" placeholder="0.00" step="any">
                </div>
                <div class="input-group">
                    <label id="sellLabel">Precio Venta (VES)</label>
                    <input type="number" id="inputSell" placeholder="0.00" step="any">
                </div>
                <div class="input-group">
                    <label>Ganancia Deseada (%)</label>
                    <input type="number" id="inputProfit" placeholder="10" value="10" step="0.1">
                </div>
                <div class="result-container">
                    <label>Tasa LuCash $</label>
                    <input type="text" id="resultTasa" class="readonly" value="0.00" readonly>
                </div>
                <div id="errorMessage" class="error-message">Por favor, ingrese valores v√°lidos.</div>
            </div>
        </section>

        <!-- GENERATOR SECTION -->
        <section id="generatorSection" style="display: none;">
            <div class="card">
                <div class="input-group">
                    <label>Tasa Base COP ‚Üí VES</label>
                    <input type="number" id="genRateCopVes" placeholder="Ej: 8.80">
                </div>
                <div class="input-group">
                    <label>Tasa Base VES ‚Üí COP</label>
                    <input type="number" id="genRateVesCop" placeholder="Ej: 3.50">
                </div>
                <button class="action-btn" onclick="generateImage()">‚ú® Descargar Imagen</button>
            </div>
        </section>

        <!-- COLLABORATORS SECTION -->
        <section id="collaboratorsSection" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h3>Gesti√≥n de Colaboradores</h3>
                    <button class="action-btn small" onclick="openColabModal()">+ A√±adir</button>
                </div>
                <div class="table-container">
                    <table id="colabTable">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Op. Totales</th>
                                <th>Ganancia Acumulada</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

    <!-- MODAL: TRANSACTION FORM -->
    <div id="txModal" class="modal">
        <div class="modal-content card">
            <h3 id="txModalTitle">Nueva Transacci√≥n</h3>
            <form id="txForm">
                <div class="form-grid">
                    <div class="input-group">
                        <label>Fecha</label>
                        <input type="date" id="txDate" required>
                    </div>
                    <div class="input-group">
                        <label>Cliente</label>
                        <input type="text" id="txClient">
                    </div>
                    <div class="input-group">
                        <label>Tipo</label>
                        <select id="txType">
                            <option value="COP_VES">COP ‚Üí VES</option>
                            <option value="VES_COP">VES ‚Üí COP</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Tasa Cambio</label>
                        <input type="number" id="txRate" step="any" required>
                    </div>
                    <div class="input-group">
                        <label>Monto Recibido</label>
                        <input type="number" id="txAmountRec" step="any" required>
                    </div>
                    <div class="input-group">
                        <label>USDT Comprados</label>
                        <input type="number" id="txUsdtBought" step="any" required>
                    </div>
                    <div class="input-group">
                        <label>USDT Vendidos</label>
                        <input type="number" id="txUsdtSold" step="any" required>
                    </div>
                    <div class="input-group">
                        <label>Com. Binance Compra</label>
                        <input type="number" id="txBinanceFeeBuy" step="any" value="0.10" required>
                    </div>
                    <div class="input-group">
                        <label>Com. Binance Venta</label>
                        <input type="number" id="txBinanceFeeSell" step="any" value="0" required>
                    </div>
                    <div class="input-group">
                        <label>Colaborador</label>
                        <select id="txColab">
                            <option value="">Ninguno</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Evidencia (Screenshots)</label>
                        <input type="file" id="txEvidence" accept="image/*" class="file-input" multiple>
                    </div>


                </div>
                <div class="modal-footer">
                    <button type="button" class="secondary-btn" onclick="closeModal('txModal')">Cancelar</button>
                    <button type="submit" class="action-btn">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Hidden container for Image Generation -->
    <!-- Hidden container for Image Generation -->
    <div id="captureContainer" class="capture-container">
        <div class="capture-header">
            <div class="logo-box">LuCash $</div>
            <div class="capture-title">TABLA DE REMESAS</div>
        </div>

        <div class="tables-wrapper">
            <!-- Colombia -> Venezuela -->
            <div class="rate-column">
                <div class="column-header">
                    <div class="country-info">
                        <span class="flag">co</span> Colombia ‚Æï Venezuela <span class="flag">ve</span>
                    </div>
                    <div class="rate-display">Tasa del d√≠a: <span id="displayRateCopVes">0.00</span></div>
                </div>
                <table class="rate-table" id="tableCopVes">
                    <thead>
                        <tr>
                            <th>ENV√çAS (COP)</th>
                            <th>RECIBES (VES)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="rate-note">
                    Despu√©s de $1.000.000 <br>
                    Tasa es: <span id="noteRateCopVes">0.00</span>
                </div>
            </div>

            <!-- Venezuela -> Colombia -->
            <div class="rate-column">
                <div class="column-header">
                    <div class="country-info">
                        <span class="flag">ve</span> Venezuela ‚Æï Colombia <span class="flag">co</span>
                    </div>
                    <div class="rate-display">Tasa del d√≠a: <span id="displayRateVesCop">0.00</span></div>
                </div>
                <table class="rate-table" id="tableVesCop">
                    <thead>
                        <tr>
                            <th>ENV√çAS (VES)</th>
                            <th>RECIBES (COP)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="rate-note">
                    Despu√©s de 5.000 Bs <br>
                    Tasa es: <span id="noteRateVesCop">0.00</span>
                </div>
            </div>
        </div>

        <div class="capture-footer-text">
            Generado por LuCash $ App
        </div>
    </div>

    <!-- Evidence Viewer Modal -->
    <div id="viewerModal" class="modal">
        <div class="modal-content" style="max-width: 800px; text-align: center;">
            <div id="evidenceDisplay"></div>
            <div class="modal-footer" style="justify-content: center;">
                <button type="button" class="secondary-btn" onclick="closeModal('viewerModal')">Cerrar</button>
            </div>
        </div>
    </div>

    <script src="./financial-logic.js?v=8"></script>
    <script src="./app.js?v=8"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registrado', reg))
                    .catch(err => console.log('Error SW', err));
            });
        }
    </script>
</body>

</html>